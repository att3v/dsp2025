import json
import logging
import os
import signal
import sys
from uuid import uuid4

from cassandra.cluster import Cluster
from confluent_kafka import Consumer

KAFKA_BORKER = os.getenv("KAFKA_BROKER", "locahost:9092")
KAFKA_TOPIC = "cve_data"
CASSANDRA_HOSTS = os.getenv(
    "CASSANDRA_HOSTS", "cassandra.cassandra.svc.cluster.local:9042"
).split(",")

consumer = Consumer(
    {
        "bootstrap.servers": KAFKA_BORKER,
        "group.id": "cve_consumer",
        "auto.offset.reset": "earliest",
    }
)
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s",
)
logger = logging.getLogger(__name__)
handler = logging.StreamHandler(sys.stdout)
handler.setLevel(logging.INFO)
formatter = logging.Formatter("%(asctime)s - %(levelname)s - %(message)s")
handler.setFormatter(formatter)
logger.addHandler(handler)

cassandra_cluster = Cluster(CASSANDRA_HOSTS)
session = cassandra_cluster.connect()
session.set_keyspace("threat_intelligence")

consumer.subscribe([KAFKA_TOPIC])
logger.info(f"Consumer initialized and subscribed to topic: {KAFKA_TOPIC}")


def graceful_shutdown():
    logger.info("Shutting down consumer...")
    if consumer:
        consumer.close()
    exit(0)


signal.signal(signal.SIGTERM, graceful_shutdown)
signal.signal(signal.SIGINT, graceful_shutdown)


def poll_for_messages():
    logger.info("Consumer started polling for messages...")
    for message in consumer:
        if message.error():
            logger.error(f"Consumer error: {message.error()}")
        else:
            process_message(message)
            logger.info(f"Message processed: {message.value()}")
    logger.info("Consumer stopped polling for messages.")
    consumer.close()


def process_message(msg):
    cve_data = json.loads(msg.value())
    cve_id = cve_data["cve_id"]
    timestamp = cve_data["timestamp"]
    lastmodified = cve_data["lastmodified"]
    baseScore = cve_data["baseScore"]
    severity = cve_data["severity"]
    description = cve_data["description"]
    source = cve_data["source"]
    status = cve_data["status"]

    insert_cve_data(
        cve_id,
        timestamp,
        lastmodified,
        baseScore,
        severity,
        description,
        source,
        status,
    )


def insert_cve_data(
    cve_id, timestamp, lastmodified, baseScore, severity, description, source, status
):
    cassandra_q = f"""
        INSERT INTO vulnerabilities (id, cve, timestamp, lastmodified, basescore, severity, description, source, status)
        VALUES ('{cve_id}', '{timestamp}', '{lastmodified}', {baseScore}, '{severity}', '{description}', '{source}', '{status}');
    """
    try:
        session.execute(
            cassandra_q,
            (
                uuid4(),
                cve_id,
                timestamp,
                lastmodified,
                baseScore,
                severity,
                description,
                source,
                status,
            ),
        )
    except Exception as e:
        logger.error(f"Failed to insert data into Cassandra: {e}")


if __name__ == "__main__":
    poll_for_messages()
