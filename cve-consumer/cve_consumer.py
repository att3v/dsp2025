import json
import logging
import os
import signal
import sys
from uuid import uuid4

from cassandra.cluster import Cluster
from confluent_kafka import Consumer

KAFKA_BORKER = "10.36.0.3"
KAFKA_TOPIC = "cve_data"
CASSANDRA_HOSTS = ["10.10.2.64", "10.10.1.106"]

consumer = Consumer(
    {
        "bootstrap.servers": KAFKA_BORKER,
        "group.id": "cve_consumer",
        "auto.offset.reset": "earliest",
    }
)
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s",
)
logger = logging.getLogger(__name__)
handler = logging.StreamHandler(sys.stdout)
handler.setLevel(logging.INFO)
formatter = logging.Formatter("%(asctime)s - %(levelname)s - %(message)s")
handler.setFormatter(formatter)
logger.addHandler(handler)
logger.info(f"Cassandra cluster: {CASSANDRA_HOSTS}")

cassandra_cluster = Cluster(CASSANDRA_HOSTS)
session = cassandra_cluster.connect()
session.set_keyspace("threat_intelligence")

consumer.subscribe([KAFKA_TOPIC])
logger.info(f"Consumer initialized and subscribed to topic: {KAFKA_TOPIC}")


def graceful_shutdown():
    logger.info("Shutting down consumer...")
    if consumer:
        consumer.close()
    exit(0)


signal.signal(signal.SIGTERM, graceful_shutdown)
signal.signal(signal.SIGINT, graceful_shutdown)


def poll_for_messages():
    logger.info("Consumer started polling for messages...")
    try:
        while True:
            message = consumer.poll(timeout=1.0)
            if message is None:
                continue
            if message.error():
                logger.error(f"Consumer error: {message.error()}")
            else:
                process_message(message)
                logger.info(f"Message processed: {message.value()}")
    except KeyboardInterrupt:
        logger.info("Polling interrupted by user.")
    finally:
        consumer.close()
        logger.info("Consumer stopped polling for messages.")


def process_message(msg):
    cve_data = json.loads(msg.value())
    cve_id = cve_data["cve_id"]
    timestamp = cve_data["timestamp"]
    lastmodified = cve_data["lastmodified"]
    baseScore = cve_data["baseScore"]
    severity = cve_data["severity"]
    description = cve_data["description"]
    source = cve_data["source"]
    status = cve_data["status"]

    insert_cve_data(
        cve_id,
        timestamp,
        lastmodified,
        baseScore,
        severity,
        description,
        source,
        status,
    )


def insert_cve_data(
    cve_id, timestamp, lastmodified, baseScore, severity, description, source, status
):
    cassandra_q = """
        INSERT INTO vulnerabilities (id, cve, timestamp, lastmodified, basescore, severity, description, source, status)
        VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s)
    """
    try:
        session.execute(
            cassandra_q,
            (
                uuid4(),
                cve_id,
                timestamp,
                lastmodified,
                baseScore,
                severity,
                description,
                source,
                status,
            ),
        )
        logger.info(f"Inserted CVE data into Cassandra: {cve_id}")
    except Exception as e:
        logger.error(f"Failed to insert data into Cassandra: {e}")


if __name__ == "__main__":
    poll_for_messages()
